import {
  CodeSurfer,
  CodeSurferColumns,
  Step,
} from 'code-surfer';

import {
  Image,
  Invert,
  Notes,
  Split,
  SplitRight,
  Appear,
  Head,
} from 'mdx-deck';

import { github, dracula } from '@code-surfer/themes';
import customTheme from '../custom-theme';
export const theme = customTheme(dracula);

import ImageLayout from '../image-split-layout';
import * as imgs from '../images';
import VideoUserMedia from '../video-user-media';
import AudioUserMedia from '../audio-user-media';
import InputDemo from '../inputer';

import Peers from '../peerjs';

<Head>
  <title>Shriek!</title>
  {Object.values(imgs).map(function (img) {
    <link rel="preload" as="image" href={img} />;
  })}
</Head>

<Image
  src={imgs.bg}
  style={{
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    paddingRight: '1rem',
    color: 'black',
    backgroundColor: 'black',
  }}
>


# Shriek

</Image>


<Notes>


I dag skal vi se p친 hvordan vi kan bruke ulike teknologier, sm칮re de sammen som en herlig lapskaus og h친pe at det kommer noe morsomt ut av det.

Med programmering i verkt칮y beltet kan du gj칮re det utroligste. P친 sitt beste kan det revolusjonere verden, p친 sitt verste 칮delegge for generasjoner. ...eller du kan lage ditt eget spill som styres av deg og din venns evne til 친 rope h칮yt og ukontrollert. I dette kurset ser vi p친 hvordan vi kan bruke innebygde API-er i nettleseren, litt matematikk og en dose kreativitet til 친 lage v친r egen utgave av Supermarked Shriek.

</Notes>


---

<Image
  src={imgs.demo}
  style={{
    backgroundSize: 'contain',
    backgroundColor: '#fff',
  }}
/>

---

## Teknologier

```

1. getUserMedia, AudioContext
2. Worklets, WebWorkers
3. SVG/DOM/nettleser API
4. WebRTC P2P og PeerJS

```

---

## Agenda

```

Del 1: `getUserMedia`, `AudioContext` og volum.
Del 2: Render Loops, User input og transform
Del 3: EventListeners
Del 4: P2P, WebRTC og PeerJS

```

---

## User Media

- MediaDevices-API brukes for tilgang til diverse media
- `getUserMedia` for tilgang til kamera eller mikrofon
- Krever "Secure Context"
- Styrer permissions

<Notes>
 I nettleser-API som omhandler "Media Devices" kan du be om tilgang til kamera eller mikrofon via `getUserMedia`.


Dette m친 lastes i en "secure context", som betyr at det m친 vanligvis skje via HTTPS. Dette er grunnet personvern, og nettleser vil pr칮ve 친 sikre at ingen blir spionert p친 via usikre tilkoblinger. Unntaket fra denne regelen er hvis nettsiden er hostet lokalt, slik som via localhost. Da blir det sett p친 som en "secure context"

Denne tilgangen til en gitt ressurs, slik som kamera eller mikrofon, h친ndteres via permissions i nettleser. Som betyr at brukeren kan trekke tilbake tilgang n친r hen vil, og derfor m친 l칮sninger som bruker "user media" v칝re ganske godt skrudd sammen for 친 h친ndtere at tilgang skrus av.

Men heldigvis, siden nettleseren tilbyr grensesnittet og funksjonalitet for 친 justere tilganger, samt hvilke kilder du skal ha tilgang til, s친 er det ikke mye kode som skal til i dette scenarioet.

  </Notes>


---

<CodeSurfer>


```ts subtitle="Det 친 lytte p친 webkamera kan gj칮res p친 noen f친 linjer"
async function getMediaStream() {
  const mediaStream = await navigator.mediaDevices.getUserMedia(
    {
      video: true,
    },
  );

  const video = document.querySelector('video');
  video.srcObject = mediaStream;
}

// Du m친 ha et video-element i DOM:
// <video autoPlay />
```

```diff 2[29:63] subtitle="Kalle getUserMedia"

```

```diff 4 subtitle="Send inn at du vil ha video"

```

```diff 8,9 subtitle="Sette stream til video-elementet som finnes i DOM"

```

</CodeSurfer>


---

Voila!

<VideoUserMedia />

<Notes>
  Og koden du s친 tidligere var bokstavelig talt det som
  skulle til for 친 vise video her
</Notes>

---

## Web Audio API

- AudioContext
- Kommuniserer igjennom noder
- Streams
- Buffers

<Notes>
  For 친 gj칮re noe med lyd fra mikronen, kan vi ta i bruk Web
  Audio API-et


Her kommer vi ogs친 innom streams og buffers

</Notes>


---

<CodeSurfer>


```ts subtitle="I stedet for 친 be om video,"
const stream = await navigator.mediaDevices.getUserMedia({
  video: true,
});
```

```ts subtitle="S친 kan du be om audio"
const stream = await navigator.mediaDevices.getUserMedia({
  audio: true,
});
```

```ts subtitle="AudioContext er fundamentet i Web Audio"
const stream = await navigator.mediaDevices.getUserMedia({
  audio: true,
});
const audioContext = new AudioContext();
```

```ts subtitle="Vi kan bruke mikrofonen som lydkilde"
const stream = await navigator.mediaDevices.getUserMedia({
  audio: true,
});
const audioContext = new AudioContext();
const source = audioContext.createMediaStreamSource(stream);
```

```ts subtitle="Prosessering av lyd g친r igjennom AudioNodes"
const stream = await navigator.mediaDevices.getUserMedia({
  audio: true,
});
const audioContext = new AudioContext();
const source = audioContext.createMediaStreamSource(stream);
const volumeNode = audioContext.createGain();
```

```ts subtitle="S친 kan du gj칮re operasjoner p친 lyden"
const stream = await navigator.mediaDevices.getUserMedia({
  audio: true,
});
const audioContext = new AudioContext();
const source = audioContext.createMediaStreamSource(stream);
const volumeNode = audioContext.createGain();
volumeNode.gain.setValueAtTime(2, audioContext.currentTime);
```

```ts subtitle="Og du kan analysere lyden"
const stream = await navigator.mediaDevices.getUserMedia({
  audio: true,
});
const audioContext = new AudioContext();
const source = audioContext.createMediaStreamSource(stream);
const volumeNode = audioContext.createGain();
volumeNode.gain.setValueAtTime(2, audioContext.currentTime);
const analyser = audioContext.createAnalyser();
```

```ts subtitle="Og nodene linkes sammen i AudioContext og rutes ut"
const stream = await navigator.mediaDevices.getUserMedia({
  audio: true,
});
const audioContext = new AudioContext();
const source = audioContext.createMediaStreamSource(stream);
const volumeNode = audioContext.createGain();
volumeNode.gain.setValueAtTime(2, audioContext.currentTime);
const analyser = audioContext.createAnalyser();
source
  .connect(volumeNode)
  .connect(analyser)
  .connect(audioContext.destination);
```

</CodeSurfer>


<Notes>
  AudioContext er boksen som inneholder alt av det som skjer
  av audio-h친ndtering i Web Audio. Den gj칮r operasjoner p친
  lyd via det som kalles audio nodes, som kan linkes sammen
  p친 en modul칝r m친te for 친 rute lyden og gj칮re operasjoner
  p친 den.
</Notes>

---

<Image
  src={imgs.audioContext}
  style={{ backgroundSize: '100%' }}
/>

---

<AudioUserMedia />

---

## AudioWorklet

- En worklet, nesten som en Web Worker
- Gir tilgang til lavere niv친 i render pipeline
- Brukes n친r det er behov for mye prosessering
- Krever "Secure Context"

---

<CodeSurfer>


```js subtitle="Batteries included: volume-worklet.js"
const ATTACK = 0.3;
const INTERVAL_MS = 200;

registerProcessor(
  "volumeworklet",
  class VolumeWorklet extends AudioWorkletProcessor {
    constructor() {
      super();
      this.previousAudioBlockVolumes = [0, 0, 0];
      this.previousSampleUpdateFrame = 0;
      this.previousSentVolume = 0;
    }

    process(inputs, outputs, parameters) {
      // select first channel (should be mono from microphone)
      const channel = inputs[0];

      // Make sure something is connected
      if (channel && channel.length > 0) {
        const samples = channel[0];

        let squaredSum = 0;
        // Calculated the squared-sum of all samples in current audio block
        for (let i = 0; i < samples.length; ++i)
          squaredSum += samples[i] * samples[i];

        // Calculate the root mean-square for samples squared-sum
        // the RMS approximates a volume across samples in current frame
        const currentVolume = Math.sqrt(squaredSum / samples.length);

        // sampleRate is available from the AudioWorklet global scope:
        // https://developer.mozilla.org/en-US/docs/Web/API/AudioWorkletGlobalScope
        // sampleRate is expressed in hertz, like 48000 Hz
        // Hertz in this case means samples per second
        // So to send an update every "INTERVAL_MS" (200 ms),
        // we must find how many samples are processed in 0.2 sec (200 / 1000)
        const updateIntervalInSamples = sampleRate * (INTERVAL_MS / 1000);

        // currentFrame is available from the AudioWorklet global scope:
        // https://developer.mozilla.org/en-US/docs/Web/API/AudioWorkletGlobalScope
        if (
          currentFrame >
          this.previousSampleUpdateFrame + updateIntervalInSamples
        ) {
          // Set current frame as update frame
          this.previousSampleUpdateFrame = currentFrame;

          // Calculate avg volume from all processed
          // audio blocks since last update
          let numberOfCalculatedVolumes =
            this.previousAudioBlockVolumes.length + 1;
          let volumeBlocksSum = currentVolume;
          for (let i = 0; i <CodeSurfer this.previousAudioBlockVolumes.length; ++i)
            volumeBlocksSum += this.previousAudioBlockVolumes[i];
          const avgVolumeAcrossAudioBlocks =
            volumeBlocksSum / numberOfCalculatedVolumes;

          // reset volume cache
          this.previousAudioBlockVolumes = [];

          // Fast attack, slow release
          // This means we want to react quickly when volume goes up
          // but more slowly when volume goes down
          this.previousSentVolume = Math.max(
            avgVolumeAcrossAudioBlocks,
            this.previousSentVolume * ATTACK
          );

          // Send volume across message port
          this.port.postMessage({ volume: this.previousSentVolume });
        } else {
          // Hasn't been 200 ms since last update,
          // cache the current volume
          this.previousAudioBlockVolumes.push(currentVolume);
        }
      }

      return true;
    }
  }
);
```

```diff 4[1:17] subtitle="Registrerer workleten"

```

```diff 4,5,6[1:51] subtitle="M친 gi den ett navn, og en klasse som arver fra AudioWorkletProcessor"

```

```diff 14 subtitle="Input og output buffers i process funksjonen"

```

```diff 16 subtitle="Inputs inneholder alle kanaler i en array"

```

```diff 22:29 subtitle="Tar kvadratisk sum av alle, og s친 kvadratisk gjennomsnitt av det igjen"

```

```diff 37:75 subtitle="Med et intervall p친 ca. 200 ms"

```

```diff 69,70 subtitle="S친 sender vi kalkulert volum over Message-port"

```

</CodeSurfer>


---

<CodeSurfer>


```ts 1:5 subtitle="Hvis vi har tilgang til mikrofon"
const stream = await navigator.mediaDevices.getUserMedia({
  audio: true,
});
const audioContext = new AudioContext();
const source = audioContext.createMediaStreamSource(stream);

await audioContext.audioWorklet.addModule(
  './volume-worklet.js',
);
const workletNode = new AudioWorkletNode(
  audioContext,
  'volumeworklet',
);
workletNode.port.onmessage = (message) => {
  console.log(message);
};

source
  .connect(workletNode)
  .connect(audioContext.destination);
```

```diff 7:9 subtitle="S친 kan vi laste inn en audio-worklet"

```

```diff 10:13 subtitle="S친 m친 vi instantiere denne som en egen node"

```

```diff 14:16 subtitle="Og instantiere denne som en egen node"

```

```diff 17:20 subtitle="Og deretter connecte denne p친 samme m친te i pipeline"

```

```diff

```

</CodeSurfer>


---

## Oppgave 1: Volume progress (20min)

Implementer uthenting av volum basert p친 UserMedia, AudioWorklets og bruk `test-volume.ts` for 친 bekrefte at alt fungerer.

---

## Pause (10min)

---

## Spill og game loops

Kontinuerlige og gradvise tilstandsendringer

<Notes>
  Et ganske kjent konsept for b친de spill men og generell
  moderne web arkitektur n친. Konseptet g친r ut p친 at du
  sender tilstand inn til et system, gj칮r n칮dvendige
  endringer p친 systemet og outputter det.
</Notes>

---

<Image src={imgs.gameLoop} />

---

<CodeSurfer>


```ts
let someInput = {};
while (true) {
  manipulateSomeInput(someInput);
  draw(someInput);
}
```

```diff 1

```

```diff 3

```

```diff 4

```

```diff 2,5

```

```diff subtitle="Men dette vil ikke fungere bra i nettleseren"

```

</CodeSurfer>


---

## Single threaded

I dette eksemplet vil vi oppta CPU-en hele tiden. Det vil ogs친 v칝re
veldig mye un칮dvendig arbeid.

---

## Spre ut over tid

Vi 칮nsker gjerne rundt `60fps` for at det ikke skal oppleves d친rlig.
Det betyr at vi skal gj칮re endringer `1000ms/60 = 16ms`.

---

<Image
  src={imgs.crp}
  style={{
    backgroundSize: 'contain',
    backgroundColor: '#fff',
  }}
/>

<Notes>
  Faktisk s친 er det slik at nettleseren uansett bare
  oppdaterer periodisk. Dette kalles ofte Critical Render
  Path.
</Notes>

---

<Image src={imgs.repaint} />

---

<Image src={imgs.repaintFaded} />

---

## `setInterval` eller `setTimeout` til unnsetning?

---

<Image src={imgs.eventloop} />

---

<CodeSurfer>


```ts
let someInput = {};
while (true) {
  manipulateSomeInput(someInput);
  draw(someInput);
}
```

```ts
let someInput = {};
setInterval(function () {
  manipulateSomeInput(someInput);
  draw(someInput);
}, 1000 / 60); // 60fps
```

```diff subtitle="游녨?"

```

```diff subtitle="游녩!"

```

</CodeSurfer>


---

## `setTimeout` og `setInterval` er ustabilt

Det er ingen garanti for at det tar n칮yaktig `16.6ms`
mellom hver kj칮ring. P친 grunn av m친ten EventLoopen i
nettleseren fungerer s친 kan den ligge litt i call stack eller queue

---

<Image src={imgs.repaintDelay} />

<Notes>
  tegner midt i state-endringer oppfattes som hikke
</Notes>

---

<Image src={imgs.repaintYank} />

<Notes>
  Yank som vil oppfattes som at du ligger alltid litt etter.
  Ikke bra i et livsviktig spill.
</Notes>

---

## rAF!

`requestAnimationFrame` alts친.

<Notes>
  L칮sningen p친 problemet blir requestAnimationFrame.
</Notes>

---

<Image
  src={imgs.crp}
  style={{
    backgroundSize: 'contain',
    backgroundColor: '#fff',
  }}
/>

<Notes>
  Her kan vi koble oss inn p친 steget som k칮res f칮r repaint.
</Notes>

---

<CodeSurfer>


```ts
let someInput = {};
setInterval(function () {
  manipulateSomeInput(someInput);
  draw(someInput);
}, 1000 / 60); // 60fps
```

```ts
let someInput = {};
function loop() {
  manipulateSomeInput(someInput);
  draw(someInput);
}
requestAnimationFrame(loop);
```

```ts subtitle="Rekursivitet"
let someInput = {};
function loop() {
  manipulateSomeInput(someInput);
  draw(someInput);
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
```

</CodeSurfer>


---

## En ting til...

`SVG` og `DOM`!

<Notes>


En vanlig m친te 친 lage spill i nettleseren p친 er 친 bruke `canvas`.
Tegne piksel for piksel p친 et tegnebrett. Vi skal gj칮re det litt enklere
for dette eksemplet derimot. Vi skal bruke ferdig tegnet, uhyre simple,
former.

S친 vi skal bruke SVG-former og manipulere de direkte via DOM og JavaScript.

</Notes>


---

<CodeSurferColumns  themes={[github, dracula]} >


<Step>


```html
<div id="foo" />
```

```ts
const foo = document.querySelector('#foo');
```

</Step>


<Step>


```html
<div id="foo" />
```

```ts
const foo = document.querySelector('#foo');
// foo => <div id="foo" />
```

</Step>


</CodeSurferColumns>


---

<CodeSurferColumns  themes={[github, dracula]} >


<Step>


```html
<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="white"
    stroke-width="6"
  />
</svg>
```

<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="white"
    stroke-width="6"
  />
</svg>

</Step>


</CodeSurferColumns>


---

<CodeSurferColumns  themes={[github, dracula]} >


<Step>


```html
<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="black"
    stroke-width="6"
  />
</svg>
```

```ts
const playerPath = document.querySelector('#player');
// playerPath => <path ... />
```

</Step>


<Step>


```diff 6

```

```ts
const playerPath = document.querySelector('#player');
playerPath.getAttribute('stroke-width');
//=> '6'
```

</Step>


<Step>


```diff 5

```

```ts
const playerPath = document.querySelector('#player');
playerPath.getAttribute('stroke');
//=> 'black'
```

</Step>


<Step>


```html
<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="black"
    stroke-width="6"
  />
</svg>
```

```ts
const playerPath = document.querySelector('#player');
playerPath.setAttribute('stroke', '#f00');
```

</Step>


<Step>


```html
<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
  />
</svg>
```

```ts
const playerPath = document.querySelector('#player');
playerPath.setAttribute('stroke', '#f00');
```

</Step>


</CodeSurferColumns>


---

## Transform

---

<CodeSurferColumns  themes={[github, dracula]} >


<Step>


```html
<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
  />
</svg>
```

<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
    style={{ transition: 'all 1s ease-in' }}
  />
</svg>

</Step>


<Step>


```html
<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
    transform="translate(100, 0)"
  />
</svg>
```

<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
    style={{ transition: 'all 1s ease-in' }}
    transform="translate(100, 0)"
  />
</svg>

</Step>


<Step>


```html
<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
    transform="translate(150, 0)"
  />
</svg>
```

<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
    style={{ transition: 'all 1s ease-in' }}
    transform="translate(150, 0)"
  />
</svg>

</Step>


</CodeSurferColumns>


---

<CodeSurferColumns  themes={[github, dracula]} >


<Step>


```html
<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
  />
</svg>
```

```ts
const playerPath = document.querySelector('#player');
playerPath.setAttribute(
  'transform',
  `translate(${xValue}, 0)`,
);
```

</Step>


</CodeSurferColumns>


---

## Oppgave 2: Drag race (15min)

```
1. Lag en enkel render-loop.
2. Hent ut player fra DOM, bruk Volume fra tidligere
   til 친 kj칮re translateX p친 Player-elementet.
```

---

### Pause

---

## Mer transform

---

<CodeSurferColumns  themes={[github, dracula]} >


<Step>


```html
<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
  />
</svg>
```

<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
    style={{ transition: 'all 1s ease-in' }}
  />
</svg>

</Step>


<Step>


```html
<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
    transform="translate(100, 0)"
  />
</svg>
```

<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
    style={{ transition: 'all 1s ease-in' }}
    transform="translate(100, 0)"
  />
</svg>

</Step>


<Step>


```html
<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
    transform="translate(100, 50)"
  />
</svg>
```

<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
    style={{ transition: 'all 1s ease-in' }}
    transform="translate(100, 50)"
  />
</svg>

</Step>


<Step>


```html
<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
    transform="translate(100, 50) rotate(90)"
  />
</svg>
```

<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
    style={{ transition: 'all 1s ease-in' }}
    transform="translate(100, 50) rotate(90)"
  />
</svg>

</Step>


<Step>


```html
<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
    transform="translate(100, 50)"
  />
</svg>
```

<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
    style={{ transition: 'all 1s ease-in' }}
    transform="translate(100, 50)"
  />
</svg>

</Step>


<Step>


```

<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
    style={{
      transformOrigin: 'center',
      transformBox: 'fill-box',
    }}
    transform="translate(100, 50)"
  />
</svg>

```

<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
    style={{
      transition: 'all 1s ease-in',
      transformOrigin: 'center',
      transformBox: 'fill-box',
    }}
    transform="translate(100, 50)"
  />
</svg>

</Step>


<Step>


```

<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
    style={{
      transformOrigin: 'center',
      transformBox: 'fill-box',
    }}
    transform="translate(100, 50) rotate(90)"
  />
</svg>

```

<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
    style={{
      transition: 'all 1s ease-in',
      transformOrigin: 'center',
      transformBox: 'fill-box',
    }}
    transform="translate(100, 50) rotate(90)"
  />
</svg>

</Step>


<Step>


```

<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
    style={{
      transformOrigin: 'center',
      transformBox: 'fill-box',
    }}
    transform="translate(100, 50) rotate(-90)"
  />
</svg>

```

<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
    style={{
      transition: 'all 1s ease-in',
      transformOrigin: 'center',
      transformBox: 'fill-box',
    }}
    transform="translate(100, 50) rotate(-90)"
  />
</svg>

</Step>


<Step>


```

<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
    style={{
      transformOrigin: 'center',
      transformBox: 'fill-box',
    }}
    transform="translate(100, 0) rotate(-90) scale(2) skewY(10) skewX(10)"
  />
</svg>

```

<svg xmlns="http://www.w3.org/2000/svg">
  <path
    id="player"
    d="M44 42.6795L74 60L44 77.3205L44 42.6795Z"
    stroke="#f00"
    stroke-width="6"
    style={{
      transition: 'all 1s ease-in',
      transformOrigin: 'center',
      transformBox: 'fill-box',
    }}
    transform="translate(100, 0) rotate(-90) scale(2) skewY(10) skewX(10)"
  />
</svg>

</Step>


</CodeSurferColumns>


---

## Brukerinput

```
EventListeners og Events.
```

---

<CodeSurfer>


```ts
window.document;
```

```ts
document;
```

```ts
document.querySelector();
```

```ts
document.querySelector();
document.querySelectorAll();
```

```ts
document.querySelector();
document.querySelectorAll();
document.createElement();
```

```ts
document.querySelector();
document.querySelectorAll();
document.createElement();
document.createTextNode();
```

```ts
document.querySelector();
document.querySelectorAll();
document.createElement();
document.createTextNode();
document.addEventListener();
```

```ts
document.querySelector();
document.querySelectorAll();
document.createElement();
document.createTextNode();
document.addEventListener();
document.removeEventListener();
```

```ts
document.querySelector();
document.querySelectorAll();
document.createElement();
document.createTextNode();
document.addEventListener();
document.removeEventListener();
document.body;
```

```ts
document.querySelector();
document.querySelectorAll();
document.createElement();
document.createTextNode();
document.addEventListener();
document.removeEventListener();
document.body;
// ... osv
```

```diff 5

```

```ts
document.addEventListener();
```

</CodeSurfer>


---

<CodeSurfer>


```ts
// document.addEventListener(event: string, callback: Function);
```

```ts
// document.addEventListener(event: string, callback: Function);
document.addEventListener('click', () => {
  console.log('Clicked document');
});
```

```ts
// document.addEventListener(event: string, callback: Function);
document.addEventListener('click', (ev: MouseEvent) => {
  console.log('Clicked document');
});
```

```ts
// document.addEventListener(event: string, callback: Function);
document.addEventListener('click', (ev: MouseEvent) => {
  console.log('Clicked item', ev.target);
});
```

```ts
// document.addEventListener(event: string, callback: Function);
document.addEventListener(
  'keydown',
  (ev: KeyboardEvent) => {
    console.log('Key down');
  },
);
```

```ts
// document.addEventListener(event: string, callback: Function);
document.addEventListener(
  'keydown',
  (ev: KeyboardEvent) => {
    console.log('Key down', ev.key);
  },
);
```

```ts
// document.addEventListener(event: string, callback: Function);
document.addEventListener(
  'keydown',
  (ev: KeyboardEvent) => {
    console.log('Key down', ev.key);
  },
);
//=> Key down d
```

```ts
// document.addEventListener(event: string, callback: Function);
document.addEventListener(
  'keydown',
  (ev: KeyboardEvent) => {
    console.log('Key down', ev.key);
  },
);
//=> Key down d
//=> Key down s
```

```ts
// document.addEventListener(event: string, callback: Function);
document.addEventListener(
  'keydown',
  (ev: KeyboardEvent) => {
    console.log('Key down', ev.key);
  },
);
//=> Key down d
//=> Key down s
//=> Key down a
```

```ts
// document.addEventListener(event: string, callback: Function);
document.addEventListener(
  'keydown',
  (ev: KeyboardEvent) => {
    console.log('Key down', ev.key);
  },
);
//=> Key down d
//=> Key down s
//=> Key down a
//=> Key down Shift
```

```ts
// document.addEventListener(event: string, callback: Function);
document.addEventListener(
  'keydown',
  (ev: KeyboardEvent) => {
    console.log('Key down', ev.key);
  },
);
//=> Key down d
//=> Key down s
//=> Key down a
//=> Key down Shift
//=> Key down D
```

```ts
// document.addEventListener(event: string, callback: Function);
document.addEventListener(
  'keydown',
  (ev: KeyboardEvent) => {
    console.log('Key down', ev.key);
  },
);
//=> Key down d
//=> Key down s
//=> Key down a
//=> Key down Shift
//=> Key down D
//=> Key down S
```

```ts
// document.addEventListener(event: string, callback: Function);
document.addEventListener(
  'keydown',
  (ev: KeyboardEvent) => {
    console.log('Key down', ev.key);
  },
);
//=> Key down d
//=> Key down s
//=> Key down a
//=> Key down Shift
//=> Key down D
//=> Key down S
//=> Key down A
```

```ts
// document.addEventListener(event: string, callback: Function);
document.addEventListener('keyup', (ev: KeyboardEvent) => {
  console.log('Key up', ev.key);
});
//=> Key down d
//=> Key down s
//=> Key down a
//=> Key down Shift
//=> Key down D
//=> Key down S
//=> Key down A
```

</CodeSurfer>


---

<CodeSurferColumns  themes={[github, dracula]} >


<Step>


<InputDemo />

```ts
let active = '';
document.addEventListener('keyup', (ev) => {
  active = ev.key;
});
document.addEventListener('keyDown', () => {
  active = '';
});
```

</Step>


<Step>


<InputDemo />

```ts
let active = '';
document.addEventListener('keydown', (ev) => {
  active = ev.key;
});
document.addEventListener('keyup', () => {
  active = '';
});

function loop() {
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
```

</Step>


<Step>


<InputDemo />

```ts
let active = '';
document.addEventListener('keydown', (ev) => {
  active = ev.key;
});
document.addEventListener('keyup', () => {
  active = '';
});

const div = document.querySelector('#output');
function loop() {
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
```

</Step>


<Step>


<InputDemo />

```ts
let active = '';
document.addEventListener('keydown', (ev) => {
  active = ev.key;
});
document.addEventListener('keyup', () => {
  active = '';
});

const div = document.querySelector('#output');
function loop() {
  div.textContent = active;
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
```

</Step>


</CodeSurferColumns>


---

## N친 vet vi om vi skal svinge

```
...men
```

---

## Svinging er ikke rett frem.

---

<CodeSurfer>


```ts
const player = document.querySelector('#player');
function loop() {
  const transform = `translate(${volume}, 0)`;
  player.setAttribute('transform', transform);

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
```

```ts
const player = document.querySelector('#player');
function loop() {
  const transform = `translate(${x}, ${y}) rotate(${degrees})`;
  player.setAttribute('transform', transform);

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
```

```ts
const player = document.querySelector('#player');
let x, y, degrees;
function loop() {
  // pressed Left or pressed Right

  const transform = `translate(${x}, ${y}) rotate(${degrees})`;
  player.setAttribute('transform', transform);

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
```

```ts
const player = document.querySelector('#player');
let x, y, degrees;
function loop() {
  // pressed Left or pressed Right
  x = volume * ???;
  y = volume * ???;

  const transform = `translate(${x}, ${y}) rotate(${degrees})`;
  player.setAttribute('transform', transform);

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
```

```ts
const player = document.querySelector('#player');
let x, y, degrees;
function loop() {
  // pressed Left or pressed Right
  degrees = ???;
  x = volume * ???;
  y = volume * ???;

  const transform = `translate(${x}, ${y}) rotate(${degrees})`;
  player.setAttribute('transform', transform);

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
```

```ts
const player = document.querySelector('#player');
let x, y, degrees;
function loop() {
  // pressed Left or pressed Right
  if (isLeft) {
    degrees -= 0.04 * Math.PI;
  }
  x = volume * ???;
  y = volume * ???;

  const transform = `translate(${x}, ${y}) rotate(${degrees})`;
  player.setAttribute('transform', transform);

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
```

```ts
const player = document.querySelector('#player');
let x, y, degrees;
function loop() {
  // pressed Left or pressed Right
  if (isLeft) {
    degrees -= 0.04 * Math.PI;
  }
  if (isRight) {
    degrees += 0.04 * Math.PI;
  }
  x = volume * ???;
  y = volume * ???;

  const transform = `translate(${x}, ${y}) rotate(${degrees})`;
  player.setAttribute('transform', transform);

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
```

```ts
const player = document.querySelector('#player');
let x, y, degrees;
function loop() {
  // pressed Left or pressed Right
  if (isLeft) {
    degrees -= 0.04 * Math.PI;
  }
  if (isRight) {
    degrees += 0.04 * Math.PI;
  }
  x = TRIGONOMETRI;
  y = TRIGONOMETRI;

  const transform = `translate(${x}, ${y}) rotate(${degrees})`;
  player.setAttribute('transform', transform);

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
```

```ts
const player = document.querySelector('#player');
const cart = new Cart(player, world);
function loop() {
  const transform = `translate(${x}, ${y}) rotate(${degrees})`;
  player.setAttribute('transform', transform);

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
```

```ts
const player = document.querySelector('#player');
const cart = new Cart(player, world);
function loop() {
  const pos = cart.updateByVolume(LEFT, RIGHT, VOLUME);
  // ...
  const transform = `translate(${x}, ${y}) rotate(${degrees})`;
  player.setAttribute('transform', transform);

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
```

```ts
const player = document.querySelector('#player');
const cart = new Cart(player, world);
function loop() {
  const pos = cart.updateByVolume(LEFT, RIGHT, VOLUME);
  // ...
  const transform = `translate(${x}, ${y}) rotate(${degrees})`;
  player.setAttribute('transform', transform);

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
```

</CodeSurfer>


---

## Oppgave 3: Event Listeners og kj칮ring (10min)

```
1. Lag en ControlInput modul som holder
   tilstand p친 venstre/h칮yre.
2. Bruk cart.updateByVolume til 친 hente ut
   ny x, y, og degrees.
3. bruk transform basert p친 resultat.
4. Kj칮r cart!

(Om du t칮r: Skriv updateByVolume logikk selv)
```

---

### Pause (10min)

---

### Del 4: P2P, WebRTC og PeerJS (20min)

---

### Peer-to-peer (P2P)

- Peer-to-peer brukes i distribuerte l칮sninger
- "Peers" kobler direkte til hverandre
- Kjente l칮sninger som bruker P2P: Napster, BitTorrent, Bitcoin

---

<Peers />

---

### WebRTC

- Web Real-Time Communication
- Et nettleser-API for 친 kommunisere peer-to-peer
- St칮tter str칮mming av audio/video media
- St칮tter ogs친 친 sende andre data direkte

---

### PeerJS

Et bibliotek som bygger p친 toppen av WebRTC

---

<CodeSurfer>


```ts
import Peer from 'peerjs';
import {
  RecieveDataPayload,
  SendDataPayload,
} from '../../types';
const serverId = 'test-shriek-local';

type Listener = (data: RecieveDataPayload) => void;
export default function connect(onConnect: () => void) {
  let connIsOpened = false;
  let conn: Peer.DataConnection = null;

  let listener: Listener = () => {};
  const peer = new Peer(null, { debug: 2 });
  peer.on('open', (c) => {
    conn = peer.connect(serverId);
    conn.on('open', () => {
      connIsOpened = true;
      onConnect();
    });
    conn.on('data', listener);
  });

  return {
    onData: (cb: Listener) => {
      listener = cb;
    },
    send: (data: SendDataPayload) => {
      if (connIsOpened) {
        conn.send(data);
      }
    },
  };
}
```

```diff 9[1:31] subtitle="V친rt PeerJS-lib tilbyr en connect-funksjon"

```

```diff 9[33:53] subtitle="Hvor du kan sende inn en funksjon som kj칮res ved oppkobling"

```

```diff 24:33 subtitle="Og den returnerer et objekt med to funksjoner"

```

</CodeSurfer>


---

<CodeSurfer>


```ts
const peerClient = connectPeer(() => {
  peerClient.send({ type: 'nick', payload: 'Donkey' });
});
peerClient.onData((data) => {
  switch (data.type) {
    case 'walls':
      return world.drawWalls(data.payload);
    case 'goal':
      return world.drawGoal(data.payload);
    case 'update-opponents':
      return world.updateOpponents(data.payload);
    case 'remove-opponents':
      return world.removeOpponents(data.payload);
    case 'winner':
      alert('Winner!!\n The winner is... ' + data.payload);
      return cart.reset();
  }
});
```

</CodeSurfer>


---

#### Oppgave: PeerJS

```
Ta i bruk `connectPeer` for 친 koble til server.

1. connect og send inn Nick.
1. Tegn vegger, m친l og motstandere.
1. Gi varsel (`window.alert`) om noen vinner.
1. Send nye kordinater via server.
```

---
